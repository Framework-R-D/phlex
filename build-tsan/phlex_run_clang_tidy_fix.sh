#!/usr/bin/env bash
set -euo pipefail

# This script is generated by CMake. It wraps run-clang-tidy to allow
# selecting a specific subset of checks and/or a specific file list at
# build time via environment variables.  Use it like:
#
#   PHLEX_TIDY_CHECKS="misc-include-cleaner" PHLEX_TIDY_FILES="src/foo.cpp,src/bar.cpp" \
#     ./phlex_run_clang_tidy_fix.sh --fix --require-checks
#
# Supported environment variables:
# - PHLEX_TIDY_CHECKS: comma- or space-separated list of clang-tidy checks
# - PHLEX_TIDY_FILES: comma-separated list of files to pass to run-clang-tidy
# - PHLEX_TIDY_DRY_RUN: if set to '1', the command will only be printed

RUN_CLANG_TIDY="/opt/spack-environments/phlex-ci/.spack-env/view/bin/run-clang-tidy"
CLANG_TIDY_BIN="/opt/spack-environments/phlex-ci/.spack-env/view/bin/clang-tidy"
COMPILE_DB="/workspace/build-tsan"
CLANG_TIDY_CONFIG="/workspace/.clang-tidy"
FILES_REGEX='^(/workspace/phlex/configuration\.cpp|/workspace/phlex/utilities/hashing\.cpp|/workspace/phlex/utilities/resource_usage\.cpp|/workspace/phlex/graph/serializer_node\.cpp|/workspace/phlex/model/algorithm_name\.cpp|/workspace/phlex/model/data_cell_counter\.cpp|/workspace/phlex/model/data_layer_hierarchy\.cpp|/workspace/phlex/model/data_cell_index\.cpp|/workspace/phlex/model/identifier\.cpp|/workspace/phlex/model/product_matcher\.cpp|/workspace/phlex/model/product_store\.cpp|/workspace/phlex/model/products\.cpp|/workspace/phlex/model/product_specification\.cpp|/workspace/phlex/core/concurrency\.cpp|/workspace/phlex/core/consumer\.cpp|/workspace/phlex/core/declared_fold\.cpp|/workspace/phlex/core/declared_observer\.cpp|/workspace/phlex/core/declared_output\.cpp|/workspace/phlex/core/declared_predicate\.cpp|/workspace/phlex/core/declared_provider\.cpp|/workspace/phlex/core/declared_transform\.cpp|/workspace/phlex/core/declared_unfold\.cpp|/workspace/phlex/core/detail/make_algorithm_name\.cpp|/workspace/phlex/core/detail/maybe_predicates\.cpp|/workspace/phlex/core/detail/filter_impl\.cpp|/workspace/phlex/core/edge_creation_policy\.cpp|/workspace/phlex/core/edge_maker\.cpp|/workspace/phlex/core/filter\.cpp|/workspace/phlex/core/framework_graph\.cpp|/workspace/phlex/core/glue\.cpp|/workspace/phlex/core/input_arguments\.cpp|/workspace/phlex/core/message\.cpp|/workspace/phlex/core/message_sender\.cpp|/workspace/phlex/core/node_catalog\.cpp|/workspace/phlex/core/multiplexer\.cpp|/workspace/phlex/core/products_consumer\.cpp|/workspace/phlex/core/registrar\.cpp|/workspace/phlex/core/registration_api\.cpp|/workspace/phlex/core/product_query\.cpp|/workspace/phlex/core/store_counters\.cpp|/workspace/phlex/app/load_module\.cpp|/workspace/phlex/app/run\.cpp|/workspace/phlex/app/phlex\.cpp|/workspace/plugins/layer_generator\.cpp|/workspace/plugins/generate_layers\.cpp|/workspace/plugins/python/src/pymodule\.cpp|/workspace/plugins/python/src/modulewrap\.cpp|/workspace/plugins/python/src/configwrap\.cpp|/workspace/plugins/python/src/lifelinewrap\.cpp|/workspace/plugins/python/src/errorwrap\.cpp|/workspace/test/concepts\.cpp|/workspace/test/adjust_config\.cpp|/workspace/test/configuration\.cpp|/workspace/test/string_literal\.cpp|/workspace/test/type_deduction\.cpp|/workspace/test/type_id\.cpp|/workspace/test/identifier\.cpp|/workspace/test/yielding_driver\.cpp|/workspace/test/allowed_families\.cpp|/workspace/test/vector_of_abstract_types\.cpp|/workspace/test/cached_execution\.cpp|/workspace/test/class_registration\.cpp|/workspace/test/different_hierarchies\.cpp|/workspace/test/filter_impl\.cpp|/workspace/test/filter\.cpp|/workspace/test/framework_graph\.cpp|/workspace/test/function_registration\.cpp|/workspace/test/hierarchical_nodes\.cpp|/workspace/test/layer_generator\.cpp|/workspace/test/multiple_function_registration\.cpp|/workspace/test/output_products\.cpp|/workspace/test/data_cell_counting\.cpp|/workspace/test/data_cell_index\.cpp|/workspace/test/product_handle\.cpp|/workspace/test/product_matcher\.cpp|/workspace/test/product_store\.cpp|/workspace/test/fold\.cpp|/workspace/test/replicated\.cpp|/workspace/test/serializer\.cpp|/workspace/test/product_query\.cpp|/workspace/test/provider_test\.cpp|/workspace/test/type_distinction\.cpp|/workspace/test/unfold\.cpp|/workspace/test/benchmarks/fibonacci_numbers\.cpp|/workspace/test/benchmarks/benchmarks_provider\.cpp|/workspace/test/benchmarks/last_index\.cpp|/workspace/test/benchmarks/read_id\.cpp|/workspace/test/benchmarks/read_index\.cpp|/workspace/test/benchmarks/plus_one\.cpp|/workspace/test/benchmarks/plus_101\.cpp|/workspace/test/benchmarks/accept_even_ids\.cpp|/workspace/test/benchmarks/accept_even_numbers\.cpp|/workspace/test/benchmarks/accept_fibonacci_numbers\.cpp|/workspace/test/benchmarks/verify_even_fibonacci_numbers\.cpp|/workspace/test/benchmarks/verify_difference\.cpp|/workspace/test/max-parallelism/check_parallelism\.cpp|/workspace/test/max-parallelism/provide_parallelism\.cpp|/workspace/test/memory-checks/many_events\.cpp|/workspace/test/plugins/module\.cpp|/workspace/test/plugins/ij_source\.cpp|/workspace/test/plugins/output\.cpp|/workspace/test/utilities/sized_tuple\.cpp|/workspace/test/utilities/sleep_for\.cpp|/workspace/test/utilities/thread_counter\.cpp|/workspace/test/mock-workflow/timed_busy\.cpp|/workspace/test/mock-workflow/id_provider\.cpp|/workspace/test/mock-workflow/ion_and_scint\.cpp|/workspace/test/mock-workflow/pd_fast_sim\.cpp|/workspace/test/mock-workflow/MC_truth_algorithm\.cpp|/workspace/test/mock-workflow/largeant\.cpp|/workspace/test/mock-workflow/three_tuple_algorithm\.cpp|/workspace/test/demo-giantdata/waveforms\.cpp|/workspace/test/demo-giantdata/waveform_generator_input\.cpp|/workspace/test/demo-giantdata/waveform_generator\.cpp|/workspace/test/demo-giantdata/user_algorithms\.cpp|/workspace/test/demo-giantdata/unfold_transform_fold\.cpp|/workspace/test/python/source\.cpp)'

DO_FIX=0
EXPORT_FIXES_FILE=""
while [ "$#" -gt 0 ]; do
  case "$1" in
    --fix)
      DO_FIX=1
      shift
      ;;
    --export-fixes)
      EXPORT_FIXES_FILE="$2"
      shift 2
      ;;
    *)
      # ignore unknown args for forward-compat
      shift
      ;;
  esac
done

# Normalize checks if provided
CHECKS_ARG=""
if [ -n "${PHLEX_TIDY_CHECKS:-}" ]; then
  # normalize commas/spaces to a single comma-separated list
  CHECKS=$(printf "%s" "$PHLEX_TIDY_CHECKS" | tr ',' ' ' | xargs -n1 | paste -sd, -)
  CHECKS_ARG="-checks=-*,${CHECKS}"
fi

# Build file list (if any)
FILES_ARG_LIST=()
if [ -n "${PHLEX_TIDY_FILES:-}" ]; then
  # allow comma separated list
  IFS=',' read -r -a _tmp_files <<< "${PHLEX_TIDY_FILES}"
  for _f in "${_tmp_files[@]}"; do
    # trim
    _f=$(echo "${_f}" | awk '{gsub(/^[ \t]+|[ \t]+$/,"",$0); print $0}')
    [ -n "${_f}" ] && FILES_ARG_LIST+=("${_f}")
  done
fi

CMD=("$RUN_CLANG_TIDY" -p "$COMPILE_DB" -clang-tidy-binary "$CLANG_TIDY_BIN" -config-file "$CLANG_TIDY_CONFIG")
[ -n "$CHECKS_ARG" ] && CMD+=("$CHECKS_ARG")
[ -n "$EXPORT_FIXES_FILE" ] && CMD+=("-export-fixes=$EXPORT_FIXES_FILE")
CMD+=("-source-filter" "$FILES_REGEX")
[ "$DO_FIX" -eq 1 ] && CMD+=("-fix")

if [ ${#FILES_ARG_LIST[@]} -gt 0 ]; then
  CMD+=("${FILES_ARG_LIST[@]}")
fi

if [ "${PHLEX_TIDY_DRY_RUN:-0}" = "1" ]; then
  echo "DRY RUN: ${CMD[*]}"
  exit 0
fi

exec "${CMD[@]}"
