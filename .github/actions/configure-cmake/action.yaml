name: 'Configure CMake'
description: 'Configures CMake with preset detection and customizable options'

inputs:
  source-path:
    description: 'Path where source code is checked out'
    required: false
    default: 'phlex-src'
  build-path:
    description: 'Path for build directory'
    required: false
    default: 'phlex-build'
  build-type:
    description: 'CMake build type (Release, Debug, etc.)'
    required: false
    default: 'Release'
  extra-options:
    description: 'Additional CMake configuration options'
    required: false
    default: ''
  enable-form:
    description: 'Enable FORM support'
    required: false
    default: 'ON'
  form-root-storage:
    description: 'Enable FORM root storage'
    required: false
    default: 'ON'
  generator:
    description: 'Specify CMake generator'
    required: false
    default: 'Ninja'

runs:
  using: 'composite'
  steps:
    - shell: bash
      run: |
        # Source the entrypoint script
        . $GITHUB_WORKSPACE/${{ inputs.source-path }}/ci/entrypoint.sh
        
        cd $GITHUB_WORKSPACE/${{ inputs.build-path }}
        
        SOURCE_DIR="$GITHUB_WORKSPACE/${{ inputs.source-path }}"

        # Determine preset usage
        if [ -f "$SOURCE_DIR/CMakePresets.json" ]; then
          echo "Configuring with CMake presets"
          preset_arg="--preset=default"
        else
          echo "Configuring without presets"
          unset preset_arg
        fi

        echo "Source directory: $SOURCE_DIR"
        echo "Build directory: $(pwd)"
        echo "Build type: ${{ inputs.build-type }}"
        echo "Generator: ${{ inputs.generator }}"

        # Configure CMake with Ninja generator
        cmake $preset_arg "$SOURCE_DIR" \
          -G ${{ inputs.generator }} \
          -DCMAKE_BUILD_TYPE=${{ inputs.build-type }} \
          -DPHLEX_USE_FORM=${{ inputs.enable-form }} \
          -DFORM_USE_ROOT_STORAGE=${{ inputs.form-root-storage }} \
          ${{ inputs.extra-options }}
