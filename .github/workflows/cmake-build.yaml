name: Phlex Continuous Integration
run-name: ${{ github.actor }} building and testing Phlex

on:
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-24.04

    container:
      image: ghcr.io/framework-r-d/phlex-ci:2025-08-19a

    steps:
    - name: Check out main branch from github
      uses: actions/checkout@v4
      with:
        path: phlex-src

    - name: Build
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        mkdir -p $GITHUB_WORKSPACE/phlex-build
        cd $GITHUB_WORKSPACE/phlex-build
        cmake $GITHUB_WORKSPACE/phlex-src -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DPHLEX_USE_FORM=ON -DFORM_USE_ROOT_STORAGE=ON
        cmake --build . -j $(nproc)

    - name: Test
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        ctest -j $(nproc)
