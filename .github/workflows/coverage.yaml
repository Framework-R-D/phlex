# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Code Coverage
run-name: "${{ github.actor }} running code coverage for Phlex"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      phlex-coverage-compiler:
        description: 'Compiler to use for coverage build (gcc or clang)'
        required: false
        default: 'clang'
      phlex-enable-form:
        description: 'Enable FORM integration (set to OFF to exclude FORM sources)'
        required: false
        default: 'ON'

jobs:
  detect-coverage-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}
      changed_files: ${{ steps.filter.outputs.matched_files }}

    steps:
    - name: Check out source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: phlex-src

    - name: Detect coverage relevant changes
      id: filter
      uses: ./phlex-src/.github/actions/detect-relevant-changes
      with:
        repo-path: phlex-src
        base-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
        file-type: |
          cpp
          cmake

    - name: Report detection outcome
      run: |
        if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
          echo "::notice::No coverage relevant changes detected; workflow will be skipped."
        else
          echo "::group::Coverage relevant files"
          printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
          echo "::endgroup::"
        fi

  coverage:
    needs: detect-coverage-changes
    if: ${{ needs.detect-coverage-changes.outputs.has_changes == 'true' }}
    runs-on: ubuntu-24.04

    container:
      image: phlex-ci:2025-10-30

    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    outputs:
      has_coverage_xml: ${{ steps.coverage_outputs.outputs.has_coverage_xml }}
      artifact_upload_available: ${{ steps.artifact_runtime.outputs.available }}

    steps:
    - name: Determine coverage options
      id: coverage_options
      shell: bash
      run: |
        set -euo pipefail
        requested_compiler="${{ github.event_name == 'workflow_dispatch' && github.event.inputs['phlex-coverage-compiler'] || '' }}"
        default_compiler="clang"
        requested_form="${{ github.event_name == 'workflow_dispatch' && github.event.inputs['phlex-enable-form'] || '' }}"
        default_form="ON"
        compiler="${requested_compiler:-$default_compiler}"
        form="${requested_form:-$default_form}"
        echo "compiler=$compiler" >> "$GITHUB_OUTPUT"
        echo "enable_form=$form" >> "$GITHUB_OUTPUT"

    - name: Check out source code
      uses: actions/checkout@v4
      with:
        path: phlex-src

    - name: Setup build environment
      uses: ./phlex-src/.github/actions/setup-build-env

    - name: Configure CMake with GCC coverage
      id: configure_gcc
      if: ${{ steps.coverage_options.outputs.compiler == 'gcc' }}
      uses: ./phlex-src/.github/actions/configure-cmake
      with:
        cpp-compiler: g++
        preset: coverage-gcc
        enable-form: ${{ steps.coverage_options.outputs.enable_form }}
        form-root-storage: ${{ steps.coverage_options.outputs.enable_form }}

    - name: Configure CMake with Clang coverage
      id: configure_clang
      if: ${{ steps.coverage_options.outputs.compiler == 'clang' }}
      uses: ./phlex-src/.github/actions/configure-cmake
      with:
        cpp-compiler: clang++
        preset: coverage-clang
        enable-form: ${{ steps.coverage_options.outputs.enable_form }}
        form-root-storage: ${{ steps.coverage_options.outputs.enable_form }}

    - name: Unknown Compiler Error
      if: ${{ always() && steps.coverage_options.outputs.compiler != 'gcc' && steps.coverage_options.outputs.compiler != 'clang' }}
      run: |
        echo "ERROR: Unknown compiler '${{ steps.coverage_options.outputs.compiler }}'. Must be 'gcc' or 'clang'."
        exit 1

    - name: Build with coverage instrumentation
      uses: ./phlex-src/.github/actions/build-cmake

    - name: Run tests with coverage
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        ctest -j $(nproc) --output-on-failure

    - name: Generate coverage reports (GCC)
      id: report_gcc
      if: ${{ steps.coverage_options.outputs.compiler == 'gcc' }}
      shell: bash
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        echo "Using GCC/gcovr/lcov bundled coverage target."
        cmake --build . --target coverage-gcov -v
        if [ -f coverage.xml ]; then
          echo "Coverage XML generated successfully"
          echo "Coverage XML size: $(wc -c < coverage.xml) bytes"
          echo "Source paths in coverage.xml:"
          grep -o '<source>.*</source>' coverage.xml | head -5
        else
          echo "ERROR: coverage.xml not found"
          ls -la *.xml || echo "No XML files found"
          exit 1
        fi
        if [ -d coverage-html ]; then
          echo "HTML coverage report generated successfully"
        else
          echo "WARNING: coverage-html directory not found (lcov/genhtml may be unavailable)"
        fi
        if [ -f coverage.info.final ]; then
          echo "LCOV summary available at coverage.info.final"
        fi

    - name: Generate coverage reports (Clang)
      id: report_clang
      if: ${{ steps.coverage_options.outputs.compiler == 'clang' }}
      shell: bash
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        echo "Using Clang/llvm-cov coverage targets."
        cmake --build . --target coverage-llvm -v
        if [ -f coverage-llvm.txt ]; then
          echo "LLVM coverage summary:"
          if command -v head >/dev/null 2>&1; then
            head -n 20 coverage-llvm.txt
          else
            cat coverage-llvm.txt
          fi
        else
          echo "ERROR: coverage-llvm.txt not found"
          ls -la *.txt || echo "No LLVM coverage summary found"
          exit 1
        fi

    - name: Capture coverage artifact availability
      id: coverage_outputs
      if: ${{ steps.report_gcc.outcome != 'skipped' || steps.report_clang.outcome != 'skipped' }}
      shell: bash
      run: |
        cd "$GITHUB_WORKSPACE/phlex-build"
        if [ -f coverage.xml ]; then
          echo "has_coverage_xml=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_coverage_xml=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Unknown Coverage Report Error
      if: ${{ always() && steps.report_gcc.outcome == 'skipped' && steps.report_clang.outcome == 'skipped' }}
      run: |
        echo "ERROR: No coverage report was generated. Must run either GCC or Clang coverage report step."
        exit 1

    - name: Prepare coverage artifact bundle
      if: ${{ steps.report_gcc.outcome != 'skipped' || steps.report_clang.outcome != 'skipped' }}
      shell: bash
      run: |
        set -euo pipefail
        ARTIFACT_DIR="$GITHUB_WORKSPACE/coverage-artifacts"
        rm -rf "$ARTIFACT_DIR"
        mkdir -p "$ARTIFACT_DIR"
        cd "$GITHUB_WORKSPACE/phlex-build"
        if [ -f coverage-llvm.txt ]; then cp coverage-llvm.txt "$ARTIFACT_DIR/"; fi
        if [ -f coverage.profdata ]; then cp coverage.profdata "$ARTIFACT_DIR/"; fi
        if [ -f coverage.xml ]; then cp coverage.xml "$ARTIFACT_DIR/"; fi
        if [ -f coverage.info ]; then cp coverage.info "$ARTIFACT_DIR/"; fi
        if [ -f coverage.info.final ]; then cp coverage.info.final "$ARTIFACT_DIR/"; fi
        if [ -d coverage-html ]; then cp -R coverage-html "$ARTIFACT_DIR/"; fi

    - name: Detect artifact upload availability
      id: artifact_runtime
      if: ${{ steps.report_gcc.outcome != 'skipped' || steps.report_clang.outcome != 'skipped' }}
      shell: bash
      run: |
        if [ -n "${ACTIONS_RUNTIME_TOKEN:-}" ]; then
          echo "available=true" >> "$GITHUB_OUTPUT"
        else
          echo "::notice::ACTIONS_RUNTIME_TOKEN not available; artifact upload will be skipped."
          echo "available=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Install Node.js runtime for artifact publishing
      if: ${{ (steps.report_gcc.outcome != 'skipped' || steps.report_clang.outcome != 'skipped') && steps.artifact_runtime.outputs.available == 'true' && github.actor != 'nektos/act' }}
      run: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt-get update
        apt-get install -y nodejs

    - name: Upload coverage bundle
      if: ${{ (steps.report_gcc.outcome != 'skipped' || steps.report_clang.outcome != 'skipped') && steps.artifact_runtime.outputs.available == 'true' && github.actor != 'nektos/act' }}
      uses: actions/upload-artifact@v4
      with:
        name: coverage-generated
        path: coverage-artifacts/
        retention-days: 30

  coverage-upload:
    needs: coverage
    if: ${{ needs.coverage.result == 'success' && needs.coverage.outputs.artifact_upload_available == 'true' && github.actor != 'nektos/act' }}
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    steps:
    - name: Download coverage bundle
      uses: actions/download-artifact@v4
      with:
        name: coverage-generated
        path: coverage-artifacts

    - name: Upload coverage to Codecov
      if: ${{ needs.coverage.outputs.has_coverage_xml == 'true' }}
      uses: codecov/codecov-action@v4
      with:
        file: coverage-artifacts/coverage.xml
        flags: unittests
        name: phlex-coverage
        fail_ci_if_error: true
        verbose: true
        root_dir: .
        token: ${{ env.CODECOV_TOKEN }}

    - name: Publish HTML coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html-report
        path: coverage-artifacts/coverage-html/
        if-no-files-found: warn
        retention-days: 30

  coverage-skipped:
    needs: detect-coverage-changes
    if: ${{ needs.detect-coverage-changes.outputs.has_changes != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: No relevant coverage changes detected
      run: echo "No relevant C++ changes detected; coverage workflow skipped."
