# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Code Coverage
run-name: "${{ github.actor }} running code coverage for Phlex"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      phlex-coverage-compiler:
        description: 'Compiler to use for coverage build (gcc or clang)'
        required: false
        default: 'ethel'

env:
  BUILD_TYPE: Coverage

jobs:
  detect-coverage-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}
      changed_files: ${{ steps.filter.outputs.matched_files }}

    steps:
    - name: Check out source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: phlex-src

    - name: Detect coverage relevant changes
      id: filter
      uses: ./phlex-src/.github/actions/detect-relevant-changes
      with:
        repo-path: phlex-src
        base-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
        file-type: |
          cpp
          cmake

    - name: Report detection outcome
      run: |
        if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
          echo "::notice::No coverage relevant changes detected; workflow will be skipped."
        else
          echo "::group::Coverage relevant files"
          printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
          echo "::endgroup::"
        fi

  coverage:
    needs: detect-coverage-changes
    if: ${{ needs.detect-coverage-changes.outputs.has_changes == 'true' }}
    runs-on: ubuntu-24.04

    container:
      image: phlex-ci:2025-10-30

    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      PHLEX_COVERAGE_COMPILER: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.phlex-coverage-compiler || secrets.PHLEX_COVERAGE_COMPILER || 'ethel' }}

    steps:
    - name: Check out source code
      uses: actions/checkout@v4
      with:
        path: phlex-src

    - name: Setup build environment
      uses: ./phlex-src/.github/actions/setup-build-env

    - name: Configure CMake with GCC coverage
      id: configure_gcc
      if: ${{ env.PHLEX_COVERAGE_COMPILER == 'gcc' }}
      uses: ./phlex-src/.github/actions/configure-cmake
      with:
        cpp-compiler: g++
        preset: coverage-gcc

    - name: Configure CMake with Clang coverage
      id: configure_clang
      if: ${{ env.PHLEX_COVERAGE_COMPILER == 'clang' }}
      uses: ./phlex-src/.github/actions/configure-cmake
      with:
        cpp-compiler: clang++
        preset: coverage-clang

    - name: Unknown Compiler Error
      if: ${{ always() && steps.configure_gcc.outcome == 'skipped' && steps.configure_clang.outcome == 'skipped' }}
      run: |
        echo "ERROR: Unknown compiler '${PHLEX_COVERAGE_COMPILER}'. Must be 'gcc' or 'clang'."
        exit 1

    - name: Build with coverage instrumentation
      uses: ./phlex-src/.github/actions/build-cmake

    - name: Run tests with coverage
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        ctest -j $(nproc) --output-on-failure

    - name: Generate coverage reports (GCC)
      id: report_gcc
      if: ${{ env.PHLEX_COVERAGE_COMPILER == 'gcc' }}
      shell: bash
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        echo "Using GCC/gcovr/lcov coverage targets."
        cmake --build . --target coverage-xml
        if [ -f coverage.xml ]; then
          echo "Coverage XML generated successfully"
          echo "Coverage XML size: $(wc -c < coverage.xml) bytes"
          echo "Source paths in coverage.xml:"
          grep -o '<source>.*</source>' coverage.xml | head -5
          echo "Preparing generated sources for coverage mapping..."
          GENERATED_ROOT="$GITHUB_WORKSPACE/phlex-src/.coverage-generated"
          cmake --build "$GITHUB_WORKSPACE/phlex-build" --target coverage-symlink-clean
          mkdir -p "$GENERATED_ROOT"
          find "$GITHUB_WORKSPACE/phlex-build" -type f \
            \( -name '*.cpp' -o -name '*.hpp' \) \
            -print0 | while IFS= read -r -d '' src; do
              rel="${src#$GITHUB_WORKSPACE/phlex-build/}"
              dest="$GENERATED_ROOT/$rel"
              mkdir -p "$(dirname "$dest")"
              cp "$src" "$dest"
            done
          echo "Normalizing coverage XML paths for Codecov via CMake target..."
          cmake --build "$GITHUB_WORKSPACE/phlex-build" --target coverage-xml-normalize
          rm -rf "$GENERATED_ROOT"
        else
          echo "ERROR: coverage.xml not found"
          ls -la *.xml || echo "No XML files found"
          exit 1
        fi
        echo "Generating HTML coverage report..."
        cmake --build . --target coverage-html || echo "HTML coverage generation failed (lcov issues), continuing..."

    - name: Generate coverage reports (Clang)
      id: report_clang
      if: ${{ env.PHLEX_COVERAGE_COMPILER == 'clang' }}
      shell: bash
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        echo "Using Clang/llvm-cov coverage targets."
        cmake --build . --target coverage-llvm -v
        cmake --build . --target coverage-llvm-normalize -v
        cmake --build . --target coverage-llvm-summary -v
        if [ -f coverage-llvm.txt ]; then
          echo "LLVM coverage summary:" && cat coverage-llvm.txt | head -20
        else
          echo "ERROR: coverage-llvm.txt not found"
          ls -la *.txt || echo "No LLVM coverage summary found"
          exit 1
        fi

    - name: Unknown Coverage Report Error
      if: ${{ always() && steps.report_gcc.outcome == 'skipped' && steps.report_clang.outcome == 'skipped' }}
      run: |
        echo "ERROR: No coverage report was generated. Must run either GCC or Clang coverage report step."
        exit 1

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ../phlex-build/coverage.xml
        flags: unittests
        name: phlex-coverage
        fail_ci_if_error: true
        verbose: true
        working-directory: ${{ github.workspace }}/phlex-src
        root_dir: .
        token: ${{ env.CODECOV_TOKEN }}

    - name: Upload HTML coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-html-report
        path: phlex-build/coverage-html/
        retention-days: 30

  coverage-skipped:
    needs: detect-coverage-changes
    if: ${{ needs.detect-coverage-changes.outputs.has_changes != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: No relevant coverage changes detected
      run: echo "No relevant C++ changes detected; coverage workflow skipped."
