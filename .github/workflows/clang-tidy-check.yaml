name: Clang-Tidy Check
'run-name': "${{ github.actor }} running clang-tidy check"

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  detect-clang-tidy-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    container:
      image: ghcr.io/framework-r-d/phlex-ci-rg:2025-10-10
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PULL_TOKEN }}

    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}
      changed_files: ${{ steps.filter.outputs.matched_files }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: phlex-src

    - name: Detect clang-tidy relevant changes
      id: filter
      uses: ./phlex-src/.github/actions/detect-relevant-changes
      with:
        repo-path: phlex-src
        base-ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event.before }}
        head-ref: ${{ github.sha }}
        rg-type: cpp
        rg-type-add: |
          cpp:*.c.in
          cpp:*.cc.in
          cpp:*.cpp.in
          cpp:*.cxx.in
          cpp:*.c++.in
          cpp:*.h.in
          cpp:*.hh.in
          cpp:*.hpp.in
          cpp:*.hxx.in
          cpp:*.h++.in
        include-globs: |
          srcs/phlex/**

    - name: Report detection outcome
      run: |
        if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
          echo "::notice::No clang-tidy relevant changes detected; job will be skipped."
        else
          echo "::group::Clang-tidy relevant files"
          printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
          echo "::endgroup::"
        fi

  clang-tidy-check:
    needs: detect-clang-tidy-changes
    if: ${{ needs.detect-clang-tidy-changes.outputs.has_changes == 'true' }}
    runs-on: ubuntu-24.04

    container:
      image: ghcr.io/framework-r-d/phlex-ci:2025-10-08
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PULL_TOKEN }}
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: phlex-src

    - name: Setup build environment
      uses: ./phlex-src/.github/actions/setup-build-env

    - name: Configure CMake (Debug)
      uses: ./phlex-src/.github/actions/configure-cmake
      with:
        build-type: Debug
        extra-options: -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run clang-tidy using CMake target
      run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build

        echo "Running clang-tidy checks using CMake target..."

        if ! cmake --build . --target clang-tidy-check 2>&1 | tee clang-tidy.log; then
          echo ""
          echo "::error::Clang-tidy found issues in the code"
          echo "Review the output above for details"
          echo "Comment '@phlexbot tidy-fix' on the PR to attempt auto-fix"
          exit 1
        fi

        echo "âœ“ No clang-tidy issues found"

    - name: Upload clang-tidy log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: clang-tidy-log
        path: phlex-build/clang-tidy.log
        retention-days: 7

  clang-tidy-check-skipped:
    needs: detect-clang-tidy-changes
    if: ${{ needs.detect-clang-tidy-changes.outputs.has_changes != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: No relevant clang-tidy changes detected
      run: echo "No clang-tidy relevant changes detected; check skipped."
