name: Clang-Tidy Fix
'run-name': "${{ github.actor }} applying clang-tidy fixes"

on:
  issue_comment:
    types:
      - created

permissions:
  pull-requests: write
  contents: write

jobs:
  parse-command:
    runs-on: ubuntu-latest
    name: Parse bot command
    if: >
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '@phlexbot tidy-fix')
    outputs:
      tidy_checks: ${{ steps.parse_comment.outputs.tidy_checks }}
      ref: ${{ steps.get_pr.outputs.ref }}
      sha: ${{ steps.get_pr.outputs.sha }}
      repo: ${{ steps.get_pr.outputs.repo }}

    steps:
      - id: parse_comment
        name: Parse comment for tidy checks
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          checks_line=$(echo "$COMMENT_BODY" | sed -nE 's/^@phlexbot[[:space:]]+tidy-fix[[:space:]]+(.*)/\1/p' | tr -d '\r')
          if [ -n "$checks_line" ]; then
            tidy_checks="$(echo "$checks_line" | tr ',' ' ' | xargs -n1 | paste -sd, -)"
            echo "tidy_checks=$tidy_checks" >> "$GITHUB_OUTPUT"
          fi
      - name: Get PR Info
        id: get_pr
        uses: Framework-R-D/phlex/.github/actions/get-pr-info@main

  apply_tidy_fixes:
    runs-on: ubuntu-24.04
    name: Apply clang-tidy fixes
    needs: parse-command
    if: ${{ needs.parse-command.result == 'success' }}

    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          path: phlex-src
          ref: ${{ needs.parse-command.outputs.ref }}
          repository: ${{ needs.parse-command.outputs.repo }}
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: Setup build environment
        uses: Framework-R-D/phlex/.github/actions/setup-build-env@main

      - name: Configure CMake for clang-tidy
        uses: Framework-R-D/phlex/.github/actions/configure-cmake@main
        with:
          build-type: Debug
          extra-options: "-DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_CXX_SCAN_FOR_MODULES=OFF"

      - name: Apply clang-tidy fixes using CMake target
        env:
          PHLEX_TIDY_CHECKS: ${{ needs.parse-command.outputs.tidy_checks }}
        run: |
          . /entrypoint.sh
          cd "$GITHUB_WORKSPACE/phlex-build"

          echo "Applying clang-tidy fixes using CMake target..."
          cmake --build . --target clang-tidy-fix -- --export-fixes clang-tidy-fixes.yaml || true
          echo "Clang-tidy fixes applied"

      - name: Upload clang-tidy report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: clang-tidy-report
          path: phlex-build/clang-tidy-fixes.yaml
          retention-days: 7

      - name: Handle fix commit
        uses: ./phlex-src/.github/actions/handle-fix-commit
        with:
          commit-message: 'Apply clang-tidy fixes'
          working-directory: phlex-src
          token: ${{ secrets.WORKFLOW_PAT }}
          pr-info-ref: ${{ needs.parse-command.outputs.ref }}
          pr-info-repo: ${{ needs.parse-command.outputs.repo }}

  clang-tidy-pr-comments:
    needs: apply_tidy_fixes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download clang-tidy report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: clang-tidy-report
          path: phlex-build
      - name: Post clang-tidy comments
        uses: platisd/clang-tidy-pr-comments@28cfb84edafa771c044bde7e4a2a3fae57463818 # v1.8.0
        with:
          clang_tidy_fixes: phlex-build/clang-tidy-fixes.yaml
          github_token: ${{ secrets.GITHUB_TOKEN }}
