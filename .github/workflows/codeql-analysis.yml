name: "CodeQL - Analyze (C++/CMake + Python)"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 0'  # weekly (UTC) â€” adjust as needed
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

env:
  BUILD_TYPE: Release

jobs:
  codeql:
    name: Analyze with CodeQL (C++, Python)
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/framework-r-d/phlex-ci:2025-10-21
    strategy:
      fail-fast: false
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: phlex-src
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp, python
          config-file: .github/codeql/codeql-config.yml
          # If you need extra query packs, list them here, e.g.
          # queries: security-and-quality

      - name: Setup build environment
        uses: ./phlex-src/.github/actions/setup-build-env

      - name: Configure CMake
        uses: ./phlex-src/.github/actions/configure-cmake
        with:
          build-type: ${{ env.BUILD_TYPE }}

      - name: Build
        uses: ./phlex-src/.github/actions/build-cmake

      - name: Test
        run: |
        . $GITHUB_WORKSPACE/phlex-src/ci/entrypoint.sh
        cd $GITHUB_WORKSPACE/phlex-build
        ctest -j $(nproc) || true

      # Run CodeQL analysis (uploads results to code scanning)
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "CodeQL"
          # If you want a SARIF artifact too, uncomment:
          sarif_output: codeql-results.sarif
